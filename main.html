<html>

<head>
  <meta charset="UTF-8">
  <title>D3 Graph Layout</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      width: 100%;
      background-color: #333;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .top-text {
      width: 100%;
      padding: 10px 20px;
      background-color: #f4f4f4;
    }


    .content {
    display: flex;
    padding: 20px;
    }

    .graph-container {
    width: 800px;
    height: 800px;
    border: 1px solid #ccc;
    margin-right: 20px; /* spacing between graph and annotation */
    }

    .annotation {
        flex: 1;
        background-color: #f4f4f4;
    }

    svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<script src='https://d3js.org/d3.v5.min.js'></script>
<style> rect {fill: lightblue; stroke: black; }</style>

<!-- Load color palettes -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<title>Federal Funding Differences</title>
<body onload='init()'>
    <div id="tooltip" style="position: absolute; visibility: hidden; background: white; border: 1px solid #ccc; padding: 5px; font-size: 12px;"></div>

    
    <header>
        <h1>Ten Year Changes in Federal Science Funding in Higher Education (2013-2023)</h1>
    </header>

    <div class="top-text">
        <p>How has federal funding for different scientific fields changed over the past ten years?</p>
        <p></p>
        <p> - The graph below will show the percentage change from each federal agency for each scientific field between 2013 and 2023.</p>
        <p> - You can mouse over each square for a tooltip that will show the funding amounts.</p>
        <p> - Clicking on the name of an agency or scientific field will bring you to a page with more details on funding over each of the past ten years.</p>
        <p></p>
        <p>
 
        <a href="https://ncses.nsf.gov/surveys/higher-education-research-development/2023" 
        target="_blank" 
        title="View the 2023 Higher Education R&D Survey results">Data is from the Higher Education Research and Development (HERD) Survey.</a></p>

    </div>

    <div class="content">
        <div class="graph-container" id="graph"></div>
        <div class="annotation">
            <p><h3>Annotation</h3></p>
            <p>Please see this sidebar for additional information on the Scientific Field and Federal Agency screens.</p>
        </div>
    </div>

<script>
async function init() {
    // host URL
    const url = 'file:///Users/andy/Assignments/DataViz/Activities/Final_Project'

    // read data
    data = await d3.csv("https://raw.githubusercontent.com/arr11-uiuc/dv/refs/heads/main/data/main_viz.csv");

    // setup dimensions
    svg_width = 800;
    svg_height = 800;

    const margin = {top:50, right:25, bottom: 30, left: 200};
    width = svg_width - margin.right - margin.left;
    height = svg_height - margin.top - margin.bottom;

    // setup axes
    //const yGroup = Array.from(new Set(data.map(d => data.agency)));
    //const xGroup = Array.from(new Set(data.map(d => d.field)));

    const yGroup = d3.map(data, function(d){return d.field;}).keys()
    const xGroup = d3.map(data, function(d){return d.agency;}).keys()

    const xAxis = d3.scaleBand()
        .range([0, width])
        .domain(xGroup)
        .padding(0.05)

    const yAxis = d3.scaleBand()
        .range([height, 0])
        .domain(yGroup)
        .padding(0.05)

    const svg = d3.select("#graph")
        .append("svg")
        .attr("width", svg_width)
        .attr("height", svg_height)
        .append("g")
        .attr("transform", "translate("+ margin.left + "," + margin.top + ")");

    svg.append("g")
        .attr("transform", "translate(0, 0)")
        .call(d3.axisTop(xAxis))
        .selectAll(".tick text")
        .style("fill", "darkblue")       // Set text color
        .style("text-decoration", "underline") // Underline text
        .attr("font-size", "12px")
        .style("cursor", "pointer")
        .on("click", function(d) {
            window.location.href = url+'/agency.html?agency='+ encodeURIComponent(d)
        })
        .select(".domain").remove()

    svg.append("g")
        .call(d3.axisLeft(yAxis))
        .selectAll(".tick text")
        .style("fill", "darkblue")       // Set text color
        .style("text-decoration", "underline") // Underline text
        .attr("font-size", "12px")
        .style("cursor", "pointer")
        .on("click", function(d) {
            window.location.href = url+'/field.html?field='+ encodeURIComponent(d)
        })
        .select(".domain").remove()

    // Build color scale
    const myColor = d3.scaleLinear()
        .domain([-100, -.50, 0, 1, 100])
        .interpolate(d3.interpolateRgb)
        .range(["red", "red", "white", "lightgreen", "darkgreen"]);

    svg.selectAll()
        .data(data, function(d) {return d.agency+':'+d.field;})
        .enter()
        .append("rect")
        .attr("x", function(d) { return xAxis(d.agency) })
        .attr("y", function(d) { return yAxis(d.field) })
        .attr("rx", 4)
        .attr("ry", 4)
        .attr("width", xAxis.bandwidth() )
        .attr("height", yAxis.bandwidth() )
        //.style("fill", function(d) { return myColor(d.dif_pct)} )
        .style("fill", "slategray")
        .style("stroke-width", 4)
        .style("stroke", "none")
        .style("opacity", 0.2)




    function trianglePath(x, y, size, direction) {
        const half = size / 2;
        if (direction === "down") {
            return `M${x},${y + half} L${x + half},${y - half} L${x - half},${y - half} Z`;
        } else {
            return `M${x},${y - half} L${x + half},${y + half} L${x - half},${y + half} Z`;
        }
    }


    svg.selectAll("path")
        .data(data)
        .enter()
        .append("path")
        .attr("d", d => trianglePath(
            xAxis(d.agency) + xAxis.bandwidth() /2,
            yAxis(d.field) + yAxis.bandwidth() /2,
            xAxis.bandwidth() * 0.8,
            d.dif_pct >= 0 ? "up" : "down"
        ))
        .attr("fill", function(d) { return myColor(d.dif_pct)});


    svg.selectAll("text")
        .data(data, function(d) {return d.agency+':'+d.field;})
        .enter()
        .append("text")
        .attr("x", d => xAxis(d.agency) + xAxis.bandwidth() /2)
        .attr("y", d => yAxis(d.field) + yAxis.bandwidth() /2)
        .attr("text-anchor", "middle")
        .attr("dominant-baseline", "central")
        .text(d => d3.format("0.0%")(d.dif_pct))
        .attr("font-size", "18px")


    svg.selectAll()
        .data(data, function(d) {return d.agency+':'+d.field;})
        .enter()
        .append("rect")
        .attr("x", function(d) { return xAxis(d.agency) })
        .attr("y", function(d) { return yAxis(d.field) })
        .attr("rx", 4)
        .attr("ry", 4)
        .attr("width", xAxis.bandwidth() )
        .attr("height", yAxis.bandwidth() )
        //.style("fill", function(d) { return myColor(d.dif_pct)} )
        .style("fill", "gray")
        .style("stroke-width", 4)
        .style("stroke", "none")
        .style("opacity", 0.0)
        //.on("mouseover", mouseover)
        //.on("mousemove", mousemove)
        //.on("mouseleave", mouseleave)
        .on("mouseover", function(d) {
            d3.select("#tooltip")
            .style("visibility", "visible")
            .html(`
                <strong>Agency:</strong> ${d.agency}<br/>
                <strong>Field:</strong> ${d.field}<br/>
                <strong>2013 funding:</strong> ${d.prior_sum}<br/>
                <strong>2023 funding:</strong> ${d.post_sum}<br/>
                <strong>Difference:</strong> ${d.difference}<br/>
                <em>Values are in $1000 units</em> 
    `);

        })
        .on("mousemove", function(event) {
            d3.select("#tooltip")
            .style("top", (d3.event.pageY + 10) + "px")
            .style("left", (d3.event.pageX + 10) + "px");
        })
        .on("mouseout", function() {
            d3.select("#tooltip")
            .style("visibility", "hidden");
        });

}


</script>
</body>
</html>